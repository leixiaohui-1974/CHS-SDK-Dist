# 任务描述：构建分层分布式水利仿真系统

请根据提供的平台框架，分步构建一个包含一个闸门、两个渠池（闸前、闸后）的串联仿真系统。本任务的核心是拆解各个智能体的功能，通过一系列由小及大的例子，最终实现一个完整的分层分布式控制与调度系统。

## 1. 最小单元独立示例

在这一部分，我们将分别展示每个核心智能体的功能，使其在最简单的环境中独立运行。

### 示例 1.1：本体仿真智能体（物理模型）

**目标**：演示纯物理组件（渠道和闸门）的动态行为。

**任务**：

1.  初始化 `upstream_canal` 和 `control_gate` 物理组件。
2.  模拟 `upstream_canal` 接收一个阶跃式入流（例如，入流从 10m³/s 变为 20m³/s）。
3.  在仿真循环中，手动推进 `upstream_canal` 和 `control_gate` 的 `step()` 方法。
4.  验证 `upstream_canal` 的水位和 `control_gate` 的出流如何响应入流的变化而变化。

**核心功能点**：展示水利模型（一维水力学或简化模型）的运行，不涉及任何控制智能体。

### 示例 1.2：传感器与执行器仿真智能体

**目标**：演示一个独立的 `PhysicalIOAgent` 如何模拟传感器的感知和执行器的物理动作。

**任务**：

1.  初始化一个 `upstream_canal` 物理组件和一个 `control_gate` 物理组件。
2.  创建 `PhysicalIOAgent`，将其与 `upstream_canal` 和 `control_gate` 绑定，并配置好其消息发布与订阅主题。
3.  创建一个简单的指令发送函数，手动向 `PhysicalIOAgent` 的指令主题发布一个目标开度。
4.  在仿真循环中，调用 `PhysicalIOAgent` 的 `run()` 方法。
5.  验证 `PhysicalIOAgent` 是否能从物理模型读取状态并带噪声发布，同时将收到的指令转化为 `control_gate` 的实际物理开度。

**核心功能点**：将传感器仿真和执行器仿真独立为一个智能体，体现物理世界与控制系统的IO接口。

### 示例 1.3：闸站控制智能体（现地PID）

**目标**：展示现地PID智能体如何实现一个本地的反馈控制闭环。

**任务**：

1.  初始化一个 `MessageBus` 和一个 `PIDController`。
2.  创建 `gate_control_agent`，将 `PIDController` 封装在其中。
3.  配置 `gate_control_agent` 订阅一个观测主题（例如，`state.upstream_canal.level`）并发布一个动作主题（例如，`action.control_gate.opening`）。
4.  创建一个模拟的传感器，手动向观测主题发布一个与设定点有偏差的水位值。
5.  验证 `gate_control_agent` 是否被触发，并向动作主题发布了正确的控制信号。

**核心功能点**：此示例聚焦于“决策”和“行动”的逻辑，将“感知”和“物理执行”抽象化。

### 示例 1.4：数字孪生智能体（高级功能）

**目标**：演示 `DigitalTwinAgent` 如何在接收到感知数据后，执行更高级的功能，如数据清洗、系统辨识和预测。

**任务**：

1.  初始化一个 `MessageBus` 和一个 `upstream_canal` 模型。
2.  创建 `DigitalTwinAgent`，订阅 `PhysicalIOAgent` 发布的数据主题（带噪声）。
3.  在仿真循环中，调用 `DigitalTwinAgent` 的 `run()` 方法。
4.  验证 `DigitalTwinAgent` 是否能对收到的数据进行平滑处理或参数辨识，并发布一个更精确的模型状态。

**核心功能点**：此示例突出了 `DigitalTwinAgent` 的“认知”功能，即从不完美的数据中提取有价值的信息。

### 示例 1.5：中心MPC调度智能体

**目标**：展示 `CentralDispatcher`（中心MPC）如何在孤立环境下接收预测信息，并输出高层调度指令。

**任务**：

1.  初始化一个 `MessageBus` 和一个 `MPCController`。
2.  创建 `central_dispatcher`，配置其MPC模型、规则和预测主题订阅。
3.  创建一个模拟的预测智能体，向预测主题发布一个未来入流的预测序列。
4.  手动发布一个初始的闸前水位状态。
5.  调用 `central_dispatcher` 的 `run()` 方法。
6.  验证 `central_dispatcher` 是否根据预测信息和当前水位，向一个命令主题（例如，`command.gate.setpoint`）发布了一个新的PID设定点。

**核心功能点**：此示例突出MPC的“前瞻性”和“优化”特性，即在物理环境变化之前，就能提前调整控制策略。

## 2. 组合与分层示例

在这一部分，我们将把上述最小单元组合起来，构建一个完整的、可运行的分层分布式系统。

### 示例 2.1：现地闭环控制

**目标**：构建一个由现地PID智能体独立工作的完整闭环控制系统。

**任务**：

1.  将示例 1.1、1.2 和 1.3 的组件和逻辑整合进一个完整的 `SimulationHarness` 仿真。
2.  `PhysicalIOAgent` 实时发布闸前水位。
3.  `gate_control_agent` 实时接收水位并调整闸门。
4.  `PhysicalIOAgent` 响应指令并改变闸门的物理状态。
5.  `upstream_canal` 的水位因入流和出流的动态平衡而变化。
6.  验证 `gate_control_agent` 是否能将闸前水位稳定维持在预设的PID设定点。

**核心功能点**：展示一个完全解耦的、事件驱动的现地控制闭环。

### 示例 2.2：分层分布式控制与复杂扰动应对

**目标**：构建一个完整的、具备分层控制能力的复杂系统，并测试其在多种扰动下的鲁棒性。

**任务**：

1.  将所有组件和所有智能体整合进 `SimulationHarness`。
2.  设置MPC的正常和应急设定点规则。
3.  设置 `rainfall_agent` 和 `water_use_agent` 注入扰动的时间和强度。
4.  运行仿真，并观察在不同扰动情景下，MPC如何调整PID的设定点，以及整个系统如何协同工作以维持稳定。

**核心功能点**：这是最终的、最完整的示例，它将验证所有智能体、预测和控制层面的协同工作能力。
